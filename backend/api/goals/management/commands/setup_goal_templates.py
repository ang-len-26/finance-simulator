from django.core.management.base import BaseCommand
from decimal import Decimal

from api.goals.models import GoalTemplate

class Command(BaseCommand):
    help = 'Configura plantillas predeterminadas para metas financieras'
    
    def __init__(self):
        super().__init__()
        self.success_count = 0
        self.error_count = 0
    
    def log_success(self, message):
        self.stdout.write(self.style.SUCCESS(f"‚úÖ {message}"))
        self.success_count += 1
    
    def log_error(self, message):
        self.stdout.write(self.style.ERROR(f"‚ùå {message}"))
        self.error_count += 1
    
    def log_info(self, message):
        self.stdout.write(self.style.WARNING(f"‚ÑπÔ∏è  {message}"))
    
    def handle(self, *args, **options):
        self.stdout.write("üéØ GOALS - Configurando plantillas de metas financieras...")
        
        self.create_goal_templates()
        self.print_summary()
    
    def create_goal_templates(self):
        """Crear plantillas de metas financieras"""
        self.stdout.write("\nüéØ Creando plantillas de metas financieras...")
        try:
            initial_count = GoalTemplate.objects.count()
            
            templates = [
                {
                    'name': 'Fondo de Emergencia',
                    'description': 'Ahorra para cubrir 6 meses de gastos en caso de emergencia. Es la base de cualquier plan financiero s√≥lido.',
                    'goal_type': 'emergency_fund',
                    'suggested_timeframe_months': 12,
                    'icon': 'shield-check',
                    'color': '#ef4444',
                    'sort_order': 1,
                    'tips': [
                        'Ahorra autom√°ticamente cada mes',
                        'Mant√©n el dinero en cuenta separada de alta liquidez',
                        'No uses este fondo para gastos no esenciales',
                        'Revisa y ajusta el monto anualmente seg√∫n tus gastos',
                        'Objetivo: 3-6 meses de gastos b√°sicos'
                    ]
                },
                {
                    'name': 'Vacaciones So√±adas',
                    'description': 'Ahorra para ese viaje que siempre has querido hacer. Planifica con anticipaci√≥n para mejores precios.',
                    'goal_type': 'vacation',
                    'suggested_amount': Decimal('3000.00'),
                    'suggested_timeframe_months': 8,
                    'icon': 'plane',
                    'color': '#22c55e',
                    'sort_order': 2,
                    'tips': [
                        'Investiga y calcula todos los costos del viaje',
                        'Busca ofertas y promociones con anticipaci√≥n',
                        'Considera viajar en temporada baja',
                        'Ahorra dinero extra para imprevistos (10-20%)',
                        'Usa apps de comparaci√≥n de precios'
                    ]
                },
                {
                    'name': 'Auto Nuevo',
                    'description': 'Ahorra para la cuota inicial de tu pr√≥ximo veh√≠culo. Una buena cuota inicial reduce el financiamiento.',
                    'goal_type': 'purchase',
                    'suggested_amount': Decimal('15000.00'),
                    'suggested_timeframe_months': 18,
                    'icon': 'car',
                    'color': '#3b82f6',
                    'sort_order': 3,
                    'tips': [
                        'Investiga modelos, precios y consumo de combustible',
                        'Considera autos usados certificados en buen estado',
                        'Negocia el mejor precio y condiciones',
                        'Incluye gastos de seguro, mantenimiento y SOAT',
                        'Compara opciones de financiamiento'
                    ]
                },
                {
                    'name': 'Casa Propia',
                    'description': 'Ahorra para la cuota inicial de tu primera vivienda. La inversi√≥n m√°s importante para tu patrimonio.',
                    'goal_type': 'purchase',
                    'suggested_amount': Decimal('50000.00'),
                    'suggested_timeframe_months': 36,
                    'icon': 'home',
                    'color': '#f59e0b',
                    'sort_order': 4,
                    'tips': [
                        'Investiga programas de gobierno (Mi Vivienda, Techo Propio)',
                        'Mant√©n buen historial crediticio en centrales de riesgo',
                        'Considera ubicaci√≥n vs precio y proyecci√≥n de valorizaci√≥n',
                        'Incluye gastos adicionales (notar√≠a, registro, tasaci√≥n)',
                        'Eval√∫a el barrio y servicios cercanos'
                    ]
                },
                {
                    'name': 'Eliminar Deudas',
                    'description': 'Lib√©rate de deudas de tarjetas de cr√©dito y pr√©stamos. Prioriza las de mayor inter√©s.',
                    'goal_type': 'debt_payment',
                    'suggested_amount': Decimal('5000.00'),
                    'suggested_timeframe_months': 12,
                    'icon': 'credit-card',
                    'color': '#dc2626',
                    'sort_order': 5,
                    'tips': [
                        'Lista todas tus deudas con montos y tasas',
                        'Prioriza deudas con mayor tasa de inter√©s',
                        'Evita contraer nuevas deudas mientras pagas',
                        'Negocia planes de pago o reestructuraci√≥n',
                        'Considera consolidar deudas si es beneficioso'
                    ]
                },
                {
                    'name': 'Educaci√≥n y Cursos',
                    'description': 'Invierte en tu desarrollo profesional con cursos, certificaciones o estudios superiores.',
                    'goal_type': 'education',
                    'suggested_amount': Decimal('8000.00'),
                    'suggested_timeframe_months': 10,
                    'icon': 'graduation-cap',
                    'color': '#8b5cf6',
                    'sort_order': 6,
                    'tips': [
                        'Investiga instituciones y programas reconocidos',
                        'Verifica retorno de inversi√≥n esperado',
                        'Busca becas, descuentos y financiamiento',
                        'Planifica los horarios con tu trabajo actual',
                        'Considera cursos online de calidad'
                    ]
                },
                {
                    'name': 'Emprendimiento',
                    'description': 'Capital inicial para tu negocio o startup. Incluye equipos, inventario y capital de trabajo.',
                    'goal_type': 'investment',
                    'suggested_amount': Decimal('20000.00'),
                    'suggested_timeframe_months': 15,
                    'icon': 'briefcase',
                    'color': '#06b6d4',
                    'sort_order': 7,
                    'tips': [
                        'Elabora un plan de negocios detallado',
                        'Investiga el mercado y competencia',
                        'Calcula costos iniciales y operativos',
                        'Considera financiamiento adicional si necesario',
                        'Mant√©n reserva para imprevistos (20-30%)'
                    ]
                },
                {
                    'name': 'Jubilaci√≥n',
                    'description': 'Ahorro complementario para tu jubilaci√≥n. Mientras antes empieces, mejor por el inter√©s compuesto.',
                    'goal_type': 'retirement',
                    'suggested_amount': Decimal('100000.00'),
                    'suggested_timeframe_months': 240,  # 20 a√±os
                    'icon': 'piggy-bank',
                    'color': '#059669',
                    'sort_order': 8,
                    'tips': [
                        'Aprovecha aportes voluntarios al SPP',
                        'Diversifica entre diferentes instrumentos',
                        'Revisa y ajusta peri√≥dicamente tus aportes',
                        'Considera inflaci√≥n en tus c√°lculos',
                        'Consulta con asesores financieros'
                    ]
                }
            ]
            
            created_templates = []
            for template_data in templates:
                template, created = GoalTemplate.objects.get_or_create(
                    name=template_data['name'],
                    defaults=template_data
                )
                if created:
                    created_templates.append(template.name)
            
            final_count = GoalTemplate.objects.count()
            if len(created_templates) > 0:
                self.log_success(f"Plantillas de metas creadas: {len(created_templates)}")
                self.stdout.write(f"   Nuevas: {', '.join(created_templates[:3])}{'...' if len(created_templates) > 3 else ''}")
            else:
                self.log_info("Las plantillas de metas ya exist√≠an")
            
            self.log_info(f"Total de plantillas: {final_count}")
                
        except Exception as e:
            self.log_error(f"Error al crear plantillas de metas: {e}")
    
    def print_summary(self):
        """Mostrar resumen del comando"""
        self.stdout.write("\n" + "="*50)
        self.stdout.write(self.style.SUCCESS("üéâ GOALS - PLANTILLAS CONFIGURADAS"))
        self.stdout.write("="*50)
        self.stdout.write(f"‚úÖ Operaciones exitosas: {self.success_count}")
        self.stdout.write(f"‚ùå Errores encontrados: {self.error_count}")
        self.stdout.write(f"\nüìä RESUMEN DE PLANTILLAS:")
        
        # Estad√≠sticas por tipo
        template_types = GoalTemplate.objects.values_list('goal_type', flat=True).distinct()
        for goal_type in template_types:
            count = GoalTemplate.objects.filter(goal_type=goal_type).count()
            self.stdout.write(f"üìã {goal_type.replace('_', ' ').title()}: {count}")
        
        self.stdout.write(f"üìà Total plantillas: {GoalTemplate.objects.count()}")
        self.stdout.write("="*50)